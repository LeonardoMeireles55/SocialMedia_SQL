-- MySQL Script generated by MySQL Workbench
-- qua 22 nov 2023 12:29:45
-- Model: New Model    Version: 1.0
-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------
-- -----------------------------------------------------
-- Schema socialmedia_api
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Schema socialmedia_api
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `socialmedia_api` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ;
USE `socialmedia_api` ;

-- -----------------------------------------------------
-- Table `socialmedia_api`.`users`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `socialmedia_api`.`users` (
  `id_users` INT(11) NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(25) NOT NULL,
  `cpf` VARCHAR(25) NOT NULL,
  `date_birth` DATE NOT NULL,
  `email` VARCHAR(25) NULL DEFAULT NULL,
  `password` VARCHAR(35) NULL DEFAULT NULL,
  PRIMARY KEY (`id_users`),
  UNIQUE INDEX `cpf` (`cpf` ASC) VISIBLE)
ENGINE = InnoDB
AUTO_INCREMENT = 12
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `socialmedia_api`.`chats`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `socialmedia_api`.`chats` (
  `id_chats` INT(11) NOT NULL AUTO_INCREMENT,
  `fk_sender` INT(11) NOT NULL,
  `fk_receiver` INT(11) NOT NULL,
  `chat_text` VARCHAR(255) NULL DEFAULT NULL,
  `chat_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP(),
  PRIMARY KEY (`id_chats`),
  INDEX `fk_sender` (`fk_sender` ASC) VISIBLE,
  INDEX `fk_receiver` (`fk_receiver` ASC) VISIBLE,
  CONSTRAINT `chats_ibfk_1`
    FOREIGN KEY (`fk_sender`)
    REFERENCES `socialmedia_api`.`users` (`id_users`),
  CONSTRAINT `chats_ibfk_2`
    FOREIGN KEY (`fk_receiver`)
    REFERENCES `socialmedia_api`.`users` (`id_users`))
ENGINE = InnoDB
AUTO_INCREMENT = 11
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `socialmedia_api`.`posts`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `socialmedia_api`.`posts` (
  `id_posts` INT(11) NOT NULL AUTO_INCREMENT,
  `fk_user` INT(11) NOT NULL,
  `text_posts` VARCHAR(255) NULL DEFAULT NULL,
  `time_posts` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP(),
  `likes_count` INT(11) NULL DEFAULT 0,
  PRIMARY KEY (`id_posts`),
  INDEX `fk_user` (`fk_user` ASC) VISIBLE,
  CONSTRAINT `posts_ibfk_1`
    FOREIGN KEY (`fk_user`)
    REFERENCES `socialmedia_api`.`users` (`id_users`))
ENGINE = InnoDB
AUTO_INCREMENT = 13
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `socialmedia_api`.`comments`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `socialmedia_api`.`comments` (
  `id_comments` INT(11) NOT NULL AUTO_INCREMENT,
  `fk_user` INT(11) NOT NULL,
  `fk_post` INT(11) NOT NULL,
  `comment_text` VARCHAR(255) NULL DEFAULT NULL,
  `comment_time` TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP(),
  PRIMARY KEY (`id_comments`),
  INDEX `fk_user` (`fk_user` ASC) VISIBLE,
  INDEX `fk_post` (`fk_post` ASC) VISIBLE,
  CONSTRAINT `comments_ibfk_1`
    FOREIGN KEY (`fk_user`)
    REFERENCES `socialmedia_api`.`users` (`id_users`),
  CONSTRAINT `comments_ibfk_2`
    FOREIGN KEY (`fk_post`)
    REFERENCES `socialmedia_api`.`posts` (`id_posts`))
ENGINE = InnoDB
AUTO_INCREMENT = 15
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `socialmedia_api`.`connections`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `socialmedia_api`.`connections` (
  `id_connections` INT(11) NOT NULL AUTO_INCREMENT,
  `fk_user` INT(11) NOT NULL,
  `fk_friend` INT(11) NOT NULL,
  `connection_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP(),
  PRIMARY KEY (`id_connections`),
  INDEX `fk_user` (`fk_user` ASC) VISIBLE,
  INDEX `fk_friend` (`fk_friend` ASC) VISIBLE,
  CONSTRAINT `connections_ibfk_1`
    FOREIGN KEY (`fk_user`)
    REFERENCES `socialmedia_api`.`users` (`id_users`),
  CONSTRAINT `connections_ibfk_2`
    FOREIGN KEY (`fk_friend`)
    REFERENCES `socialmedia_api`.`users` (`id_users`))
ENGINE = InnoDB
AUTO_INCREMENT = 11
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `socialmedia_api`.`likes`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `socialmedia_api`.`likes` (
  `id_likes` INT(11) NOT NULL AUTO_INCREMENT,
  `fk_post` INT(11) NOT NULL,
  `fk_user` INT(11) NOT NULL,
  `like_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP(),
  PRIMARY KEY (`id_likes`),
  INDEX `fk_post` (`fk_post` ASC) VISIBLE,
  INDEX `fk_user` (`fk_user` ASC) VISIBLE,
  CONSTRAINT `likes_ibfk_1`
    FOREIGN KEY (`fk_post`)
    REFERENCES `socialmedia_api`.`posts` (`id_posts`),
  CONSTRAINT `likes_ibfk_2`
    FOREIGN KEY (`fk_user`)
    REFERENCES `socialmedia_api`.`users` (`id_users`))
ENGINE = InnoDB
AUTO_INCREMENT = 12
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;

USE `socialmedia_api`;

DELIMITER $$
USE `socialmedia_api`$$
CREATE
TRIGGER `socialmedia_api`.`increment_like_count`
AFTER INSERT ON `socialmedia_api`.`likes`
FOR EACH ROW
BEGIN
    UPDATE posts
    SET likes_count = likes_count + 1
    WHERE id_posts = NEW.fk_post;
END$$

USE `socialmedia_api`$$
CREATE
TRIGGER `socialmedia_api`.`prevent_duplicate_likes`
BEFORE INSERT ON `socialmedia_api`.`likes`
FOR EACH ROW
BEGIN
    IF EXISTS (
        SELECT 1
        FROM likes
        WHERE fk_post = NEW.fk_post AND fk_user = NEW.fk_user
    ) THEN
        SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'Não é permitido dar mais de um like no mesmo post.';
    END IF;
END$$


DELIMITER ;

SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;

INSERT INTO `users` VALUES
(1,'João Silva','123.456.789-01','1990-01-01','joao@email.com','senha123'),
(2,'Carlos Santos','456.789.012-34','1982-11-30','carlos@email.com','senha789'),
(3,'Maria Oliveira','987.654.321-09','1985-05-15','maria@email.com','senha456'),
(4,'Ana Lima','234.567.890-12','1992-08-12','ana@email.com','senha234'),
(5,'Alyne Martins','065.120.957-12','1997-10-27','alyne@email.com','senha1206'),
(6,'Joana Porfirio','458.687.253-12','1990-09-09','joana@email.com','senha524'),
(7,'Conceição  Linhares','789.456.124-56','1987-12-12','conceicao@email.com','senha457'),
(8,'Leonardo Meireles','4526.701.234-85','1995-12-12','leo@email.com','senha478'),
(9,'Hanna Pereira','321.654.987-85','1987-10-10','hanna@email.com','senha753'),
(10,'Jullie Jany','451.743.873-95','1996-01-03','jullie@email.com','senha852'),
(11,'Judity Martins','987.452.337-96','2020-03-06','judity@email.com','senha951');

INSERT INTO `posts` VALUES
(1,3,'O leonardo é muito bonito.','2023-11-20 19:38:07',2),
(2,2,'Leronardo é muito chato','2023-11-20 20:12:40',1),
(3,1,'O dia está quente!','2023-11-20 20:10:40',1),
(4,4,'Vamos passar de ano!!','2023-11-20 19:32:40',1),
(5,5,'Estou com duvida no trabalho','2023-11-21 23:03:34',1),
(6,6,'Meu trabalho está me matando!!','2023-11-21 23:03:34',1),
(7,7,'Vou fazer um bolo delicioso!','2023-11-21 23:03:34',0),
(8,8,'Estou indo pra academia!!','2023-11-21 23:03:34',0),
(9,9,'Adotei mais um gato!!','2023-11-21 23:03:34',3),
(10,10,'Hoje tenho que arrumar a casa!','2023-11-21 23:03:34',0),
(11,1,'Não vou para prova dia 25.11','2023-11-22 13:33:55',0),
(12,2,'Estou com fome!!','2023-11-22 13:30:55',0);

INSERT INTO `comments` VALUES
(5,1,4,'Se Deus permitir!!!','2023-11-20 20:37:34'),
(6,2,3,'Calor dos infernoooo','2023-11-20 20:38:41'),
(7,3,1,'E verdadeeee','2023-11-20 19:00:36'),
(8,4,2,'Fiz um projeto com ele, mó legal','2023-11-20 18:00:01'),
(9,5,10,'Eu também!!','2023-11-21 22:47:50'),
(10,6,5,'Nem me faleeee','2023-11-21 22:40:50'),
(11,7,6,'Os estudos que esta me matando','2023-11-21 22:00:50'),
(12,8,7,'eu quero um pedaçooo','2023-11-21 13:47:50'),
(13,9,8,'Me espera que vou junto','2023-11-21 12:49:09'),
(14,10,9,'Mostra fotos, quero ver todos!','2023-11-21 20:49:09');


INSERT INTO `likes` VALUES
(2,1,4,'2023-11-20 21:05:39'),
(3,1,3,'2023-11-20 21:00:28'),
(4,2,1,'2023-11-20 20:40:28'),
(5,3,2,'2023-11-20 21:09:28'),
(6,4,4,'2023-11-20 21:05:28'),
(7,5,10,'2023-11-21 23:07:15'),
(8,6,10,'2023-11-21 23:00:15'),
(9,9,5,'2023-11-21 22:07:15'),
(10,9,7,'2023-11-21 23:00:15');


INSERT INTO `connections` VALUES
(1,1,2,'2023-11-20 21:23:24'),
(2,2,3,'2023-11-20 21:00:24'),
(3,3,1,'2023-11-20 19:15:52'),
(4,4,3,'2023-11-20 18:10:43'),
(5,2,4,'2023-11-20 13:24:59'),
(6,5,4,'2023-11-21 22:50:17'),
(7,6,1,'2023-11-21 23:00:47'),
(8,7,6,'2023-11-21 22:00:47'),
(9,8,9,'2023-11-21 13:00:47'),
(10,10,1,'2023-11-21 12:00:47');

INSERT INTO `chats` VALUES
(1,1,2,'Vamos sair para comer açai ?','2023-11-20 21:51:41'),
(2,2,3,'Vai para faculdade amanha ?','2023-11-20 20:02:23'),
(3,3,1,' Vai fazer o que amanha ?','2023-11-20 11:54:55'),
(4,4,2,'Você vai fazer a prova quando ?','2023-11-20 13:20:55'),
(5,5,4,'Comprou algo na blackfriday?','2023-11-21 22:42:58'),
(6,6,1,'Vai fazer o que no fim de semana ?','2023-11-21 22:00:58'),
(7,7,4,'Começou a fazer o trabalho?','2023-11-21 21:30:58'),
(8,8,1,'Esta fazendo o que agora ?','2023-11-21 13:42:58'),
(9,9,2,'Gostou do açai de ontem ?','2023-11-21 22:43:56'),
(10,10,3,'Não consegui entender nada da aula..','2023-11-21 22:40:21');
